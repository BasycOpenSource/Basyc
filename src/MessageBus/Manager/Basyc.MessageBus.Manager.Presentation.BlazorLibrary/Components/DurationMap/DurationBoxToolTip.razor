@using Basyc.Diagnostics.Shared;
@using Basyc.Diagnostics.Shared.Durations
@using Basyc.Diagnostics.Shared.Logging;
@using Basyc.MessageBus.Manager.Application.ResultDiagnostics;
@using Basyc.MessageBus.Manager.Presentation.BlazorLibrary.Components.LogIcon
@using Microsoft.Extensions.Logging;
@using ReactiveUI;
@using Basyc.Blazor.Controls.HtmlExtensions;
@inherits BasycReactiveBlazorComponentBase<DurationBoxToolTipViewModel>

<durationBoxToolTipView>
    <BasycSpaceBorder Size="SpaceSize.Big" StretchHeight="true">
        <layout>
            @*<activityName>
                <BasycHeading Size="HeadingSize.H3">
                    @Name
                </BasycHeading>
            </activityName>
            <BasycSpaceLine Start="SpaceLineSize.Medium" Visible="false" />*@
            <infoItems>
                <infoItem>
                    <div>
                        state
                    </div>
                    <div>
                        @ActivityContext.Status.ToString()
                    </div>
                </infoItem>
                <infoItem>
                    <div>
                        started
                    </div>
                    <div>
                        @Html.Methods.DiagnosticTime(StartTime)
                    </div>
                </infoItem>
                <infoItem>
                    <div>
                        lasted
                    </div>
                    <div>
                        @Html.Methods.Time(Duration)
                    </div>
                </infoItem>
            </infoItems>
            <BasycSpaceLine Start="SpaceLineSize.Medium" Visible="false" />
            <BasycHeading Size="HeadingSize.H4">
                <logHeading>
                    <logHeadingText>
                        Logs
                    </logHeadingText>
                    <logHeadingCounters>
                        <BasycSpaceLine Start="SpaceLineSize.Medium" Direction="SpaceLineDirection.Vertical" Visible="false" />
                        <LogIconView LogLevel="LogLevel.Information" />
                        <logCountNumber>
                            @LogsInformationCount
                        </logCountNumber>
                        <BasycSpaceLine Start="SpaceLineSize.Small" End="SpaceLineSize.Small" Visible="false" Direction="SpaceLineDirection.Vertical" />
                        <LogIconView LogLevel="LogLevel.Warning" />
                        <logCountNumber>
                            @LogsWarningCount
                        </logCountNumber>
                        <BasycSpaceLine Start="SpaceLineSize.Small" End="SpaceLineSize.Small" Visible="false" Direction="SpaceLineDirection.Vertical" />
                        <LogIconView LogLevel="LogLevel.Error" />
                        <logCountNumber>
                            @LogsErrorCount
                        </logCountNumber>
                    </logHeadingCounters>

                </logHeading>
            </BasycHeading>
            <logs>
                <BasycList Items="@ActivityContext.Logs" Context="log" RowGap="SpaceSize.Smaller">
                    <ItemTemplate>
                        <log>
                            <BasycSpaceBorder Size="SpaceSize.Small">
                                <logLayout>
                                    <LogIconView LogLevel="log.LogLevel" />
                                    <BasycSpaceLine Direction="SpaceLineDirection.Vertical" Start="SpaceLineSize.Small" Visible="false" />
                                    <time>
                                        @Html.Methods.DiagnosticTime(new DiagnosticTime(log.Time, ActivityContext.StartTime.BaseTime))
                                    </time>
                                    <BasycSpaceLine Direction="SpaceLineDirection.Vertical" Start="SpaceLineSize.Small" Visible="false" />
                                    <message>
                                        @log.Message
                                    </message>
                                </logLayout>
                            </BasycSpaceBorder>
                        </log>
                    </ItemTemplate>
                </BasycList>
            </logs>
        </layout>
    </BasycSpaceBorder>
</durationBoxToolTipView>

@code {
    [Inject]
    private ILogger<DurationBoxToolTip> Logger { get; init; } = null!;

    [Parameter, EditorRequired]
    public string? Name { get; set; }

    [Parameter, EditorRequired]
    public Application.ResultDiagnostics.DiagnosticTime StartTime { get; set; }

    [Parameter, EditorRequired]
    public TimeSpan Duration { get; set; }

    [Parameter, EditorRequired]
    public ServiceIdentity Service { get; set; }

    [Parameter, EditorRequired]
    public ActivityContext ActivityContext { get; set; } = null!;

    public int LogsInformationCount => ActivityContext.Logs.Where(x => x.LogLevel <= LogLevel.Information || x.LogLevel == LogLevel.None).Count();
    public int LogsWarningCount => ActivityContext.Logs.Where(x => x.LogLevel is LogLevel.Warning).Count();
    public int LogsErrorCount => ActivityContext.Logs.Where(x => x.LogLevel is LogLevel.Error or LogLevel.Critical).Count();



    protected override void OnAfterRender(bool firstRender)
    {
        base.OnAfterRender(firstRender);
    }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
    }

    public DurationBoxToolTip()
    {

    }
}
